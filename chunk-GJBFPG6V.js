import{c as p}from"./chunk-W7OXKQBZ.js";import{$ as U,S as I,T as S,W as w,X as y,Y as N,_ as R,aa as D,ba as v,ca as $,da as P,fa as W,ha as E,ia as j,ja as m,ka as A,la as F,na as b,oa as g,pa as C,qa as O,ra as q,sa as V}from"./chunk-EE5ZHYLX.js";import{a,b as h,ga as u,h as c,k as f,ma as n,tb as _,w as d}from"./chunk-4WUO5IIZ.js";var T=(()=>{class s{className_="UserService";firestore_=n(P);collectionName_=V.COLLECTION_OF_USER;collectionRef_=E(this.firestore_,this.collectionName_);router_=n(p);constructor(){}addItem(e){return c(this,null,function*(){let t=m(this.collectionRef_,m(this.collectionRef_).id),o=t.id;return console.log("docRef: ",t),console.log("addItem: ",e),o===""?console.error("addItem: id is empty"):yield C(t,a({id:o,created:Date.now(),updated:Date.now()},e)),t})}getItems(){let e=g(this.collectionRef_,b("fromDate","desc"));return console.log("queryFn: ",e),console.log("collectionRef_id: ",this.collectionRef_.id),W(e,{idField:"id"})}getItem(e){return c(this,null,function*(){let t=this._getDocRef(e);return(yield A(t)).data()})}getItemWithUid(e){return c(this,null,function*(){console.log(`${this.className_}:collection: [${this.collectionName_}], uid:[${e}]`);let t=g(this.collectionRef_,q("uid","==",e)),o=yield F(t);if(o.empty){console.log(`${this.className_}:getItemWithUid: empty`);return}let i=o.docs[0].data();return console.log(`${this.className_}:getItemWithUid: docData: `,i),i})}updateItem(e,t){console.log(`${this.className_}: updateItem: ${e}, item:`,t);let o=this._getDocRef(e);o&&(console.log(`${this.className_}: updateItem: ${e}, docRef:`,o),O(o,a({updated:Date.now()},t)))}deleteItem(e){return c(this,null,function*(){let t=yield this.getItemWithUid(e);if(!t)return;let o=t.id,r=this._getDocRef(o);console.log(`${this.className_}: deleteItem: ${o}, docRef:`,r),r&&(yield j(r))})}_getDocRef(e){return m(this.firestore_,this.collectionName_,e)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var te=(()=>{class s{className_="AuthService";auth_=n(S);userService_=n(T);user$=w(this.auth_);currentUserSig=_(void 0);constructor(){}register(e,t,o){console.log(`${this.className_}: register: `,e.toString(),t.toString(),o.toString());let r=y(this.auth_,e.toString(),o.toString()).then(i=>{let l=i.user;console.log("register: user: ",l),$(l,{displayName:t.toString()}),U(l).then(()=>{console.log(`Email verification sent to ${e}`)});let k={uid:l.uid,email:e.toString(),password:o.toString(),username:t.toString(),notes:"new user",emailVerified:!1,role:[]};this.userService_.addItem(k).then(x=>{console.log("register: user_ added: ",x)})});return d(r)}login(e,t){return c(this,null,function*(){console.log(`${this.className_}: login: `,e,t);let o=yield v(this.auth_,e,t);if(console.log("login: userCredential: ",o),o){let r=yield this.userService_.getItemWithUid(o.user.uid);console.log("login: userWithUid: ",r);let i=h(a({},r),{emailVerified:o.user.emailVerified});return console.log("login: user_: ",i),this.userService_.updateItem(i.id,i),Promise.resolve("login success")}else return Promise.reject("login failed")})}logout(){if(console.log(`${this.className_}: logout: `),this.currentUserSig){this.currentUserSig.set(null);let e=this.auth_.signOut().then(()=>{console.log("logout: success")});return d(e)}else return new f}resetPassword(e){let t=D(this.auth_,e).then(()=>{console.log("Password reset email sent")});return d(t)}delUser(){return c(this,null,function*(){console.log(`${this.className_}: delUser: `);let e=this.auth_.currentUser;if(console.log("authUser: ",e),!e)return console.error("No user is currently signed in."),Promise.reject("No user is currently signed in.");try{let t=yield this.userService_.getItemWithUid(e.uid);if(!t)return;let o=t.id,r=I.credential(e.email,t.password);return yield R(e,r),yield N(e),yield this.userService_.deleteItem(e.uid),console.log("User and user data deleted successfully"),Promise.resolve()}catch(t){throw console.error("Error deleting user:",t),t}})}static \u0275fac=function(t){return new(t||s)};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();export{T as a,te as b};
